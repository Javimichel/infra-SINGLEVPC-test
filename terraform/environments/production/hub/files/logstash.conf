input {
  file {
    path => "/var/log/data/nginx/access.log"
    codec => json {
      charset => "ISO-8859-1"
    }
  }
}
filter {
  if [url] =~ /\/mercadolibre\/.+\/manifests\/(?!(sha256)).+$/ {
     grok {
         match => [
            "url", "/v2/(?<namespace>[^/]+)/(?<image>[^/]+)/manifests/(?<tag>.+)+"
         ]
         tag_on_failure => []
     }
     mutate {
       add_field => { "registry" => "$${REGISTRY}" }
       add_field => { "environment" => "$${ENVIRONMENT}" }
       remove_field => [ "json", "@version" ]
       remove_field => [ "json", "body_bytes_sent" ]
       remove_field => [ "json", "time_local" ]
       remove_field => [ "json", "request_body" ]
       remove_field => [ "json", "referer" ]
       remove_field => [ "json", "path" ]
       remove_field => [ "json", "useragent" ]
       remove_field => [ "json", "request_time" ]
     }
  } else {
     drop { }
  }
}
output {
  file {
    path => "/var/log/data/logstash/logstash-%%{+YYYY-MM-dd}.log"
  }
  datadog_metrics {
    api_key => "${datadog_api_key}"
    dd_tags => ["namespace:%%{namespace}", "image:%%{image}" ,"tag:%%{tag}", "status:%%{status_code}", "registry:%%{registry}", "environment:%%{environment}"]
    metric_name => "container_platform.image.pull"
    metric_type => "counter"
    metric_value => 1
  }
}